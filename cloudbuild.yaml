# Working directory is now /workspace
steps:
# Pull and decrypt secrets
- name: gcr.io/cloud-builders/gcloud
  args:
  - kms
  - decrypt
  - --ciphertext-file=id_fulfilment-platform.enc
  - --plaintext-file=id_fulfilment-platform
  - --location=global
  - --keyring=fulfilment-platform
  - --key=scripts-deploy-key

# Build Dockerfile
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/java-web:$BRANCH_NAME-$REVISION_ID', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/java-web:latest', '.' ]  

# Push image to gcr
- name: 'gcr.io/cloud-builders/docker'
  args: ["push", "gcr.io/$PROJECT_ID/java-web:$BRANCH_NAME-$REVISION_ID"]
- name: 'gcr.io/cloud-builders/docker'
  args: ["push", "gcr.io/$PROJECT_ID/java-web:latest"]

# Deploy to cluster TBD
- name: 'gcr.io/cloud-builders/kubectl'
  # args: ['-n', 'default', 'set', 'image', deployment/prod-cluster',
  #  'java-web=gcr.io/$PROJECT_ID/java-web:$BRANCH_NAME-$REVISION_ID']
  args: ['apply', '-f', '/workspace/deployment.yaml']
  # args:
  # - 'set'
  # - 'image'
  # # - 'deployment/fulfilment-platform-deployment'
  # - 'deployment'
  # - 'java-web=gcr.io/#PROJECT_ID/java-web:$BRANCH_NAME-$REVISION_ID'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-east1-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=east-cluster'


logsBucket: 'fulfilment_platform_logs'
tags:
  - "java"

# Save image in Container Registry
images: 
  - 'gcr.io/$PROJECT_ID/java-web:$BRANCH_NAME-$REVISION_ID'
  - 'gcr.io/$PROJECT_ID/java-web:latest'